## 负载均衡-高可用

### 两种解决方案

	### 四层网络

​		![1606572511663](C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606572511663.png)

### 三次握手和四次挥手

​	这是传输控制层的协议：tcp和udp

	#### tcp

<img src="C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606572874220.png" alt="1606572874220" style="zoom:50%;" />

**第一次握手**：建立连接时，客户端发送 syn 包(syn=j)到服务器，并进入 SYN_SEND 状态，等待服务器确认； 

**第二次握手**：服务器收到 syn 包，必须确认客户的 SYN（ack=j+1），同时自己也发送一个 SYN 包（syn=k），即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态； 

**第三次握手**：客户端收到服务器的 SYN＋ACK 包，向服务器发送确认包 ACK(ack=k+1)，此包发送完毕，客户端和服务器进入 ESTABLISHED 状态，完成三次握手



这里我们看一下什么需要三次握手？





三次握手-数据传输-四次挥手成为一个最小的粒度，不可分割。

### 网络层

这里采用的下一跳的机制

<img src="C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606573785232.png" alt="1606573785232" style="zoom: 67%;" />

#### Gateway 网关

网关这里是下一跳的地址

#### Destination 

#### Genmask 子网掩码

当我们使用ip地址和子网掩码与运算的时候，就可以知道我们的网络号



### 当和百度建立连接的过程

<img src="C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606573966515.png" alt="1606573966515" style="zoom:67%;" />

首先，这里是采用下一跳的机制，所以我们在建立连接的过程，目标地址应该写谁呢?

我们试想一下，如果我们写的是下一跳的地址，那么这个数据包就不会再往下去传递

所以引出了链路层的概念。

这里的传输控制层只负责找到下一跳的地址，具体的还需要再封装一层，封装对应的mac地址，这里就是arp协议的内容了



## SNAT



<img src="C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606746940254.png" alt="1606746940254" style="zoom: 50%;" />



说明：

​	这里我们数据包出去的时候都要换成路由器的ip，但是这样会出现一个问题就是当端口号相同的时候那么就不知道这个数据包回去的时候应该给谁，有了这张表，找到了对应关系，我们就就知道应该发给谁了。

​	这里我们使用的是在路由器上维护一张表，存放不同的虚拟ip和对应关系。



## D-NAT

![1606747173371](C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606747173371.png)

我们来看一下这种模式，缺点是很明显的，带宽很容易成为瓶颈。

我们发送数据包和收到数据包是非对称的，发出去的很少，收到的很多，这样的话这种方式的瓶颈就出来了。

如果我们可以把 RIP 到 CIP的数据包直接扔出去，不需要像来的时候那样经过中间的节点，那么性能就能有进一步的提升。这就是接下来的 DR 这种模式了



## DR

![1606747496404](C:\Users\39371\AppData\Roaming\Typora\typora-user-images\1606747496404.png)

我们来看一下 DR 这种模式主要做了什么事情，首先隐藏 VIP 因为同一局域网不能出现相同的地址，第二步发送来的数据包修改mac地址，如果不修改的话这个数据包就会在 VIP 这里停下来了，不会再向后传递了，做完了这两件事，数据包就可以发送到 RIP 同是我们有 VIP的地址，就可以发送这样一个数据包， VIP- CIP

## 隧道

想象一下，如果你要到上海，当你出了小区门有个人把你背起来，一口气送到上海，虽然这个例子不太好，但是道理的话就是这样